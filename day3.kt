data class Coordinates(val x: Int, val y: Int)

fun returnStartFromCoordinate(position: Int, line: String): Int {
    var currentPosition = position
    while (currentPosition >= 0 && line[currentPosition].isDigit()) currentPosition--

    return currentPosition + 1
}

fun checkNeighborsForValues(position: Int, line: String): Set<Int> {
//    println("Checking position $position in line $line")

    val coordinates = mutableSetOf<Int>()
//    var currentPosition = position

    if (position < line.length - 1 && line[position + 1].isDigit()) {
        coordinates.add(returnStartFromCoordinate(position + 1, line))
    }

    if (line[position].isDigit()) {
        coordinates.add(returnStartFromCoordinate(position, line))
    }

    if (position > 0 && line[position - 1].isDigit()) {
        coordinates.add(returnStartFromCoordinate(position - 1, line))
    }

    return coordinates
}

fun getAllPartsFromNeighbor(lines: List<String>): Set<Coordinates> {
    val coordinates = mutableSetOf<Coordinates>()
    lines.forEachIndexed { row, line ->
        line.forEachIndexed { column, c ->
            if (!c.isDigit() && c != '.') {
//                println("Found special char $c at ($column, $row)")
                // check line above
                if (row > 0) {
//                    println("check line above")
                    checkNeighborsForValues(column, lines[row - 1])
                        .map { Coordinates(it, row - 1) }
                        .also {
                            coordinates.addAll(it)
                        }
                }
                // check line below
                if (row < lines.size - 1) {
//                    println("check line below")
                    checkNeighborsForValues(column, lines[row + 1])
                        .map { Coordinates(it, row + 1) }
                        .also {
                            coordinates.addAll(it)
                        }
                }
                // check column left
                if (column > 0 && line[column - 1].isDigit()) {
//                    println("check column left")
                    coordinates.add(Coordinates(returnStartFromCoordinate(column - 1, line), row))
                }
                // check column right
                if (column < line.length - 1 && line[column + 1].isDigit()) {
//                    println("check column right")
                    coordinates.add(Coordinates(column + 1, row))
                }
            }
        }
    }

    return coordinates
}

fun getAllRatiosFromGears(lines: List<String>): List<Int> {
    val ratios = mutableListOf<Int>()
    lines.forEachIndexed { row, line ->
        line.forEachIndexed { column, c ->
            if (c == '*') {
                val parts = mutableSetOf<Coordinates>()
//                println("Found special char $c at ($column, $row)")
                // check line above
                if (row > 0) {
//                    println("check line above")
                    checkNeighborsForValues(column, lines[row - 1])
                        .map { Coordinates(it, row - 1) }
                        .also {
                            parts.addAll(it)
                        }
                }
                // check line below
                if (row < lines.size - 1) {
//                    println("check line below")
                    checkNeighborsForValues(column, lines[row + 1])
                        .map { Coordinates(it, row + 1) }
                        .also {
                            parts.addAll(it)
                        }
                }
                // check column left
                if (column > 0 && line[column - 1].isDigit()) {
//                    println("check column left")
                    parts.add(Coordinates(returnStartFromCoordinate(column - 1, line), row))
                }
                // check column right
                if (column < line.length - 1 && line[column + 1].isDigit()) {
//                    println("check column right")
                    parts.add(Coordinates(column + 1, row))
                }

                if (parts.size > 1) {
                    val values = getValuesFromMap(lines, parts)
                    var current = 1
                    values.forEach { current *= it }
                    ratios.add(current)
                }
            }
        }
    }

    return ratios
}

fun getValuesFromMap(map: List<String>, neighborsCoordinates: Set<Coordinates>) : List<Int> {
    val numbers = mutableListOf<Int>()
    neighborsCoordinates.forEach { coordinates ->
        var currentPos = coordinates.x
        val value = StringBuffer()
        val line = map[coordinates.y]
        while (currentPos < line.length && line[currentPos].isDigit()) {
            value.append(line[currentPos])
            currentPos++
        }
        val fullValue = value.toString()
        if (fullValue.isNotEmpty()) numbers.add(fullValue.toInt())
    }

    return numbers
}

fun sumOfAllParts(input: String): Int {
    val lines = input.split("\n")
    val neighborsCoordinates = getAllPartsFromNeighbor(lines)
    val numbers = getValuesFromMap(lines, neighborsCoordinates)
    return numbers.sum()
}

fun sumOfAllRatios(input: String): Int {
    val lines = input.split("\n")
    val ratios = getAllRatiosFromGears(lines)
    return ratios.sum()
}

val exampleCase = "467..114..\n" +
        "...*......\n" +
        "..35..633.\n" +
        "......#...\n" +
        "617*......\n" +
        ".....+.58.\n" +
        "..592.....\n" +
        "......755.\n" +
        "...\$.*....\n" +
        ".664.598.."

val testCase = "48.................501....33.....622..............763.........331.................161.683......................................980..........\n" +
        "...491.842.....948*..................338.....*......=...........-...309.......633*....*....................*990...706...452......*..+.......\n" +
        "...*...*....................426........*..408.........................*............659...............250.........&.......*.....767...403....\n" +
        "363.....961...959#.508*223......843.406..........690................%..479.....................398.../....*............458..................\n" +
        "......=.........................................*....@946........767.........907=.................@....158.850..+670..............10*790....\n" +
        ".......39.306...679.%113...............665....874....................597...................861.........................840...855............\n" +
        ".................*.........864.....154*....#..............1*......4..........341..................731*..........783.....#.......*204........\n" +
        "..919...........706.....*......891........840..%473.........379....*149........-..115..519............668..........*423.....................\n" +
        "...*.................398.190......\$.............................#.......=.%530......\$..*..............................................475...\n" +
        ".543...@.............................834..729.&.........146......789.189........511...17........455*308..662.............530................\n" +
        ".....142....437....138*755..&53.....*..........783........./.......................*......................................./....674..315....\n" +
        "..........-./.......................826...%.....................752........414......480.................276.952...................-...*.....\n" +
        ".......131.......*654..590.................819..........\$..........-.347*..................294.....776...&...*........741.....830....230....\n" +
        "..586%.....968...........+..........319..............628......516............933..........&........+..........600.....*........*............\n" +
        "............*...................-..*.........................%........................726...876..........772..........99......145......785..\n" +
        "...........710...............352...842..941...802.....133............474.&235.................*.............*561..........#...........*.....\n" +
        ".......................................=...............*........=...................642.......774......*.........67..@921.374.......165.....\n" +
        "..250........................8..........................968...375........224...#.......*............497.833........-........................\n" +
        "...\$.....................584..*978..107&....471...............................486....408......................................@241.-555.....\n" +
        "......662\$........%......&.....................*..#186...550........=309............................76.......399............................\n" +
        "................281.........808....666.......207.........-...615.................59=....569.....197*...42...%...........572....+231...%.....\n" +
        "....758.\$777................%.....*...............433................646.834.............@.............*.........543...................769..\n" +
        "....*................995...........628...............*..................*..............=..........341...583.112+...*.......74..=341.........\n" +
        ".....775.................................744...278.128.......................126...940.839....=.....*............385.499...*............302.\n" +
        "..........*177...574.............+.......+......*................561#...590.*......\$.........231...586....................212...........#...\n" +
        ".......418....................954..433.......484...........526...........*..643......-......................&..778...............701........\n" +
        ".414..............493.....566.....*......=..................*....236...748..........543...593...*745.......57.........&.........*...........\n" +
        "....*................*.....*....46....659..%.&980..........66....................36...........87...................994.......218...443......\n" +
        "226.241.893%..........257..312............69........792............/...........+...................\$257..................790........./...184\n" +
        "................................................854*.............909.139..*276.680..&.........432............580....248.................*...\n" +
        "....136*755...@.950......................173.............95..........+...............2.877.......*668......+..+.........918*.......62....571\n" +
        "............333.*....812...\$.428.................*496..................903@...258&.............-........650.................281......+......\n" +
        "......500.......6....*...719.+......285.......955.....712*12..561.497..............667...&.843..777.................427................@....\n" +
        ".....&............506..................=..359................#....................*.....24.../.........544.436..........492=........272.....\n" +
        ".........377..........=............41-......+...........229........761...540....391..............*565.....*......449..........665.......#...\n" +
        ".887....*.....906..141.....357...\$.................%......*.................#.............-..874......811...9.....*....\$113......*.967...628\n" +
        "......406............../.......637.551....223....162.......251...........................702.*......%......*....&.905.........747...........\n" +
        "....*...........321.....801............=.....-.#...............390........845..12............399...126....283.566.....124*102......&........\n" +
        "..447..+....935...-..............41.68.87.92...105....178=....*..........*.......*..92..............................................21......\n" +
        "......505...................................*................614....948..237..512......108.58..162...454@...........395.......5.............\n" +
        "...........454..10.../............101........885.......................*..................*...*....................*........................\n" +
        "..........%....*....534......114.*................../.95......427.210..674.......371.903......81....................922.....231...346.......\n" +
        "...525........887...........#........162....211..166..@......*.....*.......281......*....................835.635............*.....*.....828.\n" +
        ".....*..............571...............+........-.............933.629./25..*...........977........*............*...........178.....749..*....\n" +
        "..993.........-................516/................394...56................477....545.*.......251.858......499....435.........&.........170.\n" +
        ".......967..73.....&.....35.........656....842.....*......*........................*...749............%..........#...........622............\n" +
        "......+...........366.86..*...........#.....=.....162...332.............-..........859............102..488.........................717......\n" +
        "347.........32........#....393.................*.................252...262....951.......823...................784...358.603.......*.....515.\n" +
        "......917..*.....\$..........................642.394..195...*..................*....\$......*.448.519................*......*....302..870.*...\n" +
        "...-..*...674.....780.547....287....................*....504...................803.688.831....*..*...........617......./..476........*...9..\n" +
        ".286..738................#.......-511..11.....581..268.....................439.............523..459...............69..373............887....\n" +
        "......................*...................555*.........45....638...964.......-...\$..........................................88*.............\n" +
        ".........802...+805.77.648.....66.676........................&..../....26......708...+.-981...239%........953..................672..........\n" +
        "......./.....#.............11.+......*....=...........756.............*.....-......298..................=...*..751.......433.........727....\n" +
        "....553.......659....907...@......@..530.218.............*......259..821...716.980..........89..851...793.614.......943....*.....961*.......\n" +
        "........*339........\$..........373...............................*...............\$.....667..\$......*..........149.....+..613................\n" +
        "..987..................*...................670...105.....347....383.605..................@....447...124..........*737...........562..15*445.\n" +
        "........-.....595*7..215.839.781.............*..*...........\$.............810....*............*...........350....................*..........\n" +
        ".........929.............*......*...362@...890...975....#..........2....../...252.576.......78...........+........685.240......695..........\n" +
        ".................475......598.152........................841.&880..#......................&....693....=.............=.....28........&384....\n" +
        "............472..*.......................\$..320.412*...................304...=.-.........395......=.113....601..............................\n" +
        "..324.738.........968...................755..*......101.......476..........90..342........................*.....638..182/...........704..139\n" +
        ".........*..610*......601...................356.../.......633*....971..........................806.....#...240...*...................../....\n" +
        "........683.....326.....*..@........749.........390.........................163@....800..483..*........792.....94...........................\n" +
        "...600................957..741...../....376............817..899.......194........50.....@....96.368..................@.......+600....-......\n" +
        "..........338%..........................*...............#....#.........*....304..+....*...........*...................236............284....\n" +
        "..423........................&763.............947.................371.187..*.......356.441......201.......................285...............\n" +
        "............75................................*....................*......696........................#...............................670....\n" +
        "...*..........*.........426.......635..-....449.758*.......314.......*..............................246.........*................58..*......\n" +
        "574.322........937.......*........#...116...........40.......*.@752..400........180....@......918.........195.49......983....559*.....82....\n" +
        "...........*.........527..842.............................817...................../.270...445..*............*...............................\n" +
        "........622.235..869*..........922*...............125*610..............*459...............&....455...........21.......964...................\n" +
        "...................................465..%542.........................47......272............+..........775.............*.....328.....@......\n" +
        ".................732*........51.&..........................853.222.........................672....148....+.........572..499.+....*....12....\n" +
        "....125..............581....*...909.787.......720*263......*....\$..881%....623*891..515..........=..................*.........726.78........\n" +
        ".....%..........715......935.........*....650............874.......................*.........127....................923.....................\n" +
        "................\$.............330*..444....\$....653............%....345..915.....960.395...........823.706..734.341...............295...342.\n" +
        ".............................................99..-...........465...&......*.............*416......*..........@....*...@......630.....*......\n" +
        ".....@.........356.......................399.+......+.....................349..................542..............853.375.......=.......132...\n" +
        "....77...=719.@.......*...../662...........*...233...781..............................&687................%.................................\n" +
        ".....................791..................933.*..........931.....884*...........-...................../...112..%601..........857............\n" +
        "583.....*292...................................438...................424......603.416.........484...104.....................*.......706.....\n" +
        ".............................452.......549.............24...997....................*............*.........767...379..........192............\n" +
        "........413.................&.....#......*....*.......*.........523.........443.412.....546......859..138*........&..66.576.................\n" +
        "..................../...........348....816.106.391......................447.........../...*..895.......................*................595.\n" +
        "...........#......771.675..................................673............*........176...856..=...627*308..696...............658............\n" +
        "....489..51...174......%..676......\$..........*........332.*.............373.350................-..........*.................*.....*........\n" +
        "181.*........*...............*822.136..888.642.202.......*..65....958........*........358........510.....*..504..747...993....339..764......\n" +
        "...........540........................................308...........@.895..942.506......*....791.......166......#...../..../...........668..\n" +
        "...................452............-....631..............................*........&.....253..../............897......*....602................\n" +
        "..748....249.24............21...847...&.....194...@...............@...865................................=....*.....550.....................\n" +
        "....*.......*.....658...................573*.......679.....760/..431.................481..........907....130.912...............240...998....\n" +
        ".605...............*.......25.......#..................................726..646....#..........607..*................698..........*...+......\n" +
        "...........301&.572........#.....101...................148........55...........*.122........./........953..........-.....602.321.929.....998\n" +
        "511.870...............@....................808.........*........*............257.......206............@........685..........*...............\n" +
        ".............903...398.....588......114.......*...990...677.....182.10\$...........%.........%.................%........................2*...\n" +
        "................*...........*...490...........987....=......803.........98......485.493.868..945.805......-........89............=944....296\n" +
        "......640.......669.........630..*.......................-....&..582.......341.........*.........*.........939......*.......................\n" +
        ".........*34....................557.....130....265.....21........*...625..\$...............*796..690................997...489....293.........\n" +
        "....917.......916............@.................*.................948..&...........148...67..................833........./..........-...943..\n" +
        "....\$........*......849...4\$..300..217........58..........................643.170...........................................................\n" +
        ".........511..853......*..............*...........355.............35-.....-....@..636.....=...595..131...496..........................=687..\n" +
        "............%........&..476......452...435.....%...*.....700..........391........*.....418.........*.........39*.&..........................\n" +
        ".16...=.............500.....................426...469.....*.............&.....#..522.............939..............395.660...................\n" +
        "...*.696.....*869........995.....413...................864.................991.......598......42.........................@..806..386........\n" +
        "337.......983.....610........104*.......100*......................-............\$79....@...461*....*685...270................*...*........240\n" +
        "......................207...........311.....741..................337.........*.................381.......*........979.....712.374.879.......\n" +
        ".......@.....554.........*.....485.....................853.............*..276.230...........7...........740...755*..................-.......\n" +
        "....927.../.....#...#...46........*466...........=.................=.531...........593......*..%....................961.....@...............\n" +
        "..........65......294..........................30..339..856.....966...........904..........791..841..........438.......#...747..............\n" +
        "..419...................614................972.......*...............131.......=.......................716..........21......................\n" +
        ".....=.79..............................&....*......76.....243..............115.......757...364..870....&...890......+...840..........55.....\n" +
        "....................383....*48...571...124...749............*................-..&.....*......*...*........@.....................201./.......\n" +
        "......752.....470.......+..........*........................964.......452........776...413...9..791...257.......687.....84......*...........\n" +
        ".........*502.*......873..850..573..729....@.....197....................*...798.........................@......*........&.....65...200..357.\n" +
        "...............307.............*..........597.....*...473.....=.......332....*..311..861*399...................472..................*.../...\n" +
        ".820.....................65....754.............713......*.....739...........622...............768/..................................967.....\n" +
        "....*.......180..........*...*.........218...............260......................519...933..........271.....36....132.....147..............\n" +
        ".935..4......@..254...815..58.689.......*..........................159..............\$...*..........*....&...\$.......*......../.414*164......\n" +
        ".......-.388.......%....................284...........833...770...*...........705.....697.......466.239.......332....489....................\n" +
        "....#.....*...........@.......288............972.........-.*......723.....*....*................................*............=..........592.\n" +
        "...535..........*.267..193.......*..367.....*..............132............509..776.790..@....466..........715.758...*115.....608............\n" +
        ".............979..*..........8.353.....*...329...@544.913..........................*.....759.*......704..%............................712...\n" +
        "...................52..170...*......459................/...#.......161........813.510.........207......@..........581..................*....\n" +
        "............#...........*..978...........581.9*815..........450...............*.......................................604.......308...725...\n" +
        "............16.........269............../.............195........217*216......890......................534.....84......-......-.............\n" +
        "....339...........................459.......644..........*.........................636.....113...%154...*....................127.....#348...\n" +
        "349...*.............402...735......@................182.121...134........%255.276...%...&.../............460....#......79...................\n" +
        "....503....22.............#.....\$............38.....+...........*....-11.......*......326...../....*853.........216......*.../180.....16....\n" +
        "..........*......92.............456..619......*..-...........=...103..........190..........353..982......25*........465.209.................\n" +
        "...485.350..........949...994.......*....379..3.22........972.........713.734.........262...........\$.......846.......*.............333-....\n" +
        "....................*..../....*121.729..+............325.............*.......*..........*........374..............+..769.....811............\n" +
        "......-..............788...488....................................851....679......*......487.....................368.........*........*.....\n" +
        "....612..528...255.................364.....................130.................317..251...............................665.206..972.957.184..\n" +
        "..........*..../.......337..475*......&..391...347...795....*.........................*......722..666...............@.......................\n" +
        "........823.\$.....+.../.........716......*........*....*.....247......329...........697......*.....*....%.....168....624.........592........\n" +
        "...98*.......916..915......245............277..&..353...719..........\$.....................846.601.37...47......................*......519..\n" +
        "......91..............720..*........\$985......976......................834...........461.........*...........................266....#...*...\n" +
        "68....................*....45..............&...........79*888.250*461.*.......%................574..........3*....408..380........383.192...\n" +
        "...........836......383...........557.....672..........................764.....944............................827..........................."

sumOfAllParts(exampleCase)
sumOfAllParts(testCase)

sumOfAllRatios(exampleCase)
sumOfAllRatios(testCase)